<html>
<title>Blackhole</title>
<link rel="stylesheet" type="text/css" href="style.css">
<body bgcolor=white text=darkblue vlink=#AC003A>

<h1><img src="logo.png"></h1>

<h2>Blackhole</h2>

Some of the spam flood can be prevented with a trap email address.
Any email sent to an email address like that is obviously spam.<p>

1. Create a directory for clapf holding IP-addresses and make it owned by
the user running the blackhole utility, it's probably you.

<pre>
mkdir /opt/av/blackhole
chown you /opt/av/blackhole
</pre>

2. Have <i>blackhole</i> to run every time the trap email address is abused.
If you have maildrop you may try with this:<p/>

<pre>
if(/trapaddress@yourdomain.kom/:h)
{
        xfilter "/usr/local/bin/blackhole -p"
	to "mail/blackhole"
	exit
}
</pre>

This will put the IP-address of the guilty host to the blackhole directory,
and train the token database if we haven't recognised the message as spam.
Finally it saves the spam to ~/mail/blackhole.<p/>

3. Run a regular cron job to purge aged entries from the blackhole directory<p>

<pre>
find /opt/av/blackhole -type f -amin +180 | xargs rm -f
</pre>

This will remove all IP entries older than 3 hours. Generally, larger sites
may use shorter TTL, smaller sites may keep the compromised IP-addresses for
a longer time.<p/>

4. (Re)configure clapf with the --enable-blackhole option then (re)compile clapf.<p/>

5. Edit the configuration and set the <b>blackhole_path</b> parameter<p/>

<pre>
blackhole_path=/opt/av/blackhole
</pre>

Then clapf checks the 2nd "Received: from " lines in the incoming message
and checks whether it is in the blackhole directory. If it is clapf frees the
token list and marks the message as spam immediately. Otherwise the usual
statistic test is run.<p>

Of course you are free to modify clapf to investigate the last Received: line
ie. the IP-address of the originating machine, but please keep in mind that
the Received: lines can be forged that's why I decided that clapf should check
only the host contacting us.<p>

You can do even more with the blackhole database. You may create a blackhole zone 
(eg. blackhole.yourdomain.kom). You may easily modify the spamdrop.c (which is soft
linked as /usr/local/bin/blackhole) to refresh (or recreate) the data of the 'blackholed
zone' (this depends on what DNS implementation you use - I recommend you
<a href="http://cr.yp.to/djbdns.html">djbdns</a>).<p/>

Then configure your SMTP server to check every incoming connection aginst this zone and
reject mail. I recommend you to extend the cron job in section 3. to refresh the data
in the blackhole zone.<p>

<center><a href="index.html">home</a></center><p>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1610427-1";
urchinTracker();
</script>


</body></html>
