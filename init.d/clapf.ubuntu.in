#!/bin/sh

### BEGIN INIT INFO
# Provides:          clapf
# Required-Start:    $syslog
# Should-Start:      mysql
# Required-Stop:
# Should-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 6
# Short-Description: Clapf mail log data collector daemon
# Description:       Clapf mail log data collector daemon
### END INIT INFO

NAME="clapf"
PREFIX="_PREFIX_"
DESC="Clapf email content filter service"
PID_FILE=`${PREFIX}/sbin/clapfconf |grep ^pidfile |cut -f2 -d=`
PID_NUMBER=`test -f ${PID_FILE} && cat ${PID_FILE}`
PID_DIR=`dirname ${PID_FILE}`
PARAMS="-d"
CLAPF_UID=`${PREFIX}/sbin/clapfconf |grep ^username |cut -f2 -d=`
CLAPF_GID=`id -gn ${CLAPF_UID}`

. /lib/lsb/init-functions

check_status(){
	test -f /proc/${PID_NUMBER}/status
}

test -d ${PID_DIR} || install -m 755 -o ${CLAPF_UID} -g ${CLAPF_GID} -d ${PID_DIR}

case "$1" in
	start)
		log_daemon_msg "Starting ${DESC}:" ${NAME}
		if check_status;
		 then
			log_failure_msg "${NAME} is already running."
			exit 1;
		 else 
			if start-stop-daemon --start --quiet --pidfile ${PID_FILE} --exec ${PREFIX}/sbin/clapf -- ${PARAMS};
			 then
				log_end_msg 0
			 else
				log_end_msg 1
		 	fi
		fi
	;;

	stop)
        if check_status;
         then
			log_daemon_msg "Stopping ${DESC}:" ${NAME}
	        if start-stop-daemon --stop --quiet --signal TERM --pidfile ${PID_FILE};
			 then
    	        log_end_msg 0
        	 else
            	log_end_msg 1
        	fi
		 else
			log_failure_msg "${DESC} is not running."
			
		fi
   ;;

	restart)
		$0 stop
		sleep 1
		$0 start
   ;;

	reload)
		echo -n "Reloading $DESC: "
        	start-stop-daemon --stop --pidfile $PIDFILE --signal HUP --exec $XNAME
        	echo "$NAME."
   ;;


	status)
		if check_status;
		 then
			echo "${NAME} is running."
		 else
			echo "${NAME} is not running."
		fi
   ;;

	*)
		echo "Usage: $0 start|stop|restart|reload|status"
esac

