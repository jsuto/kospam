SHELL = @SHELL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
srcdir = @srcdir@
sysconfdir = @sysconfdir@
mandir = @mandir@
datarootdir = @datarootdir@
localstatedir = @localstatedir@

CC = @CC@
CFLAGS = @CFLAGS@ @CPPFLAGS@
DEFS = @defs@
INCDIR = -I. @INCDIR@ @mysql_includes@
LIBDIR = -L. -L$(srcdir)/contrib/spamsum @LIBDIR@ @LDFLAGS@
LIBS = @LIBS@ @mysql_libs@
LDAP_LIBS = @ldap_libs@
CLAMAV_EXTRA_LIBS = -lclamunrar_iface -lclamunrar
OBJS = @OBJS@
STORE_OBJ = @store_obj@
USER_OBJ = @user_obj@
MYSQL_OBJS = @mysql_obj@
CLAPF_USER = @CLAPF_USER@
CLAPF_GROUP = `id -g $(CLAPF_USER)`

CLAPF_VERSION=0
CLAPF_REVISION=1
CLAPF_RELEASE=1
LIBCLAPF_VERSION=$(CLAPF_VERSION).$(CLAPF_REVISION).$(CLAPF_RELEASE)

INSTALL = @INSTALL@

all: clapf-lib clapf @spamsum@ splitmbox @parsembox@ @spamdrop@ @preparesql@ ui
install: install-clapf install-splitmbox @parsembox_install@ @spamsum_install@ @spamdrop_install@ @db_install@


clapf.conf:
	sed -e 's%pidfile=.*%pidfile=$(localstatedir)/lib/clapf/clapf.pid%' \
	-e 's%blackhole_path=.*%blackhole_path=$(localstatedir)/lib/clapf/blackhole%' \
	-e 's%sqlite3=.*%sqlite3=$(localstatedir)/lib/clapf/data/tokens.sdb%' \
	-e 's%workdir=.*%workdir=$(localstatedir)/lib/clapf/tmp%' \
	-e 's%mydbfile=.*%mydbfile=$(localstatedir)/lib/clapf/tokens.mydb%' < $(srcdir)/example.conf >$@

config.php:
	grep -v 'do not edit this file' $(srcdir)/webui/config.in.php | sed -e 's%$$clapf_conf = .*%$$clapf_conf = "$(sysconfdir)/clapf.conf";%' \
	-e 's%$$queue_directory = .*%$$queue_directory = "$(localstatedir)/lib/clapf/queue";%' >$(srcdir)/webui/$@

clapf: % : %.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ -lclapf $(LIBS) $(LDAP_LIBS) $(LIBDIR) @LDFLAGS@ @libclamav_extra_libs@

smtpscanner:	%	: %.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ -lclapf $(LIBS) $(LDAP_LIBS) $(LIBDIR) @LDFLAGS@ @libclamav_extra_libs@

clapf-lib:	$(OBJS) $(STORE_OBJ) $(MYSQL_OBJS)
	ar cr libclapf.a $(OBJS) $(MYSQL_OBJS)
	ranlib libclapf.a
	$(CC) -shared -Wl,-soname,libclapf.so.$(CLAPF_VERSION) -o libclapf.so.$(LIBCLAPF_VERSION) $(OBJS) $(MYSQL_OBJS) $(LIBS) $(LDAP_LIBS) @LDFLAGS@
	ln -sf libclapf.so.$(CLAPF_VERSION) libclapf.so

parsembox: % : %.o misc.o decoder.o list.o boundary.o parser.o cfg.o hash.o score.o chi.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

spamdrop: % : %.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ -lclapf @spamsum_libs@ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

spamstat: % : %.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ -lclapf @spamsum_libs@ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

splitmbox: % : %.o misc.o decoder.o list.o boundary.o parser.o hash.o score.o chi.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

aphash: % : %.o misc.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^

prepare-sql : % : %.o misc.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^

mydb_stat mydb_compress mydb_export:	%: %.o mydb.o misc.o hash.o chi.o score.o cfg.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

ui:
	make config.php

spamsum:
	(cd $(srcdir)/contrib/spamsum; make all)

test:
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o spamtest $(srcdir)/test.c -lclapf $(LIBS) $(LDAP_LIBS) @spamsum_libs@ $(LIBDIR) @LDFLAGS@

%.o: $(srcdir)/%.c
	$(CC) $(CFLAGS) -fPIC $(INCDIR) $(DEFS) -c $< -o $@

install-mysql-new:
	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/db-mysql.sql $(DESTDIR)$(datarootdir)/clapf/db.sql
	$(INSTALL) -m 0644 $(srcdir)/util/purge-mysql.sql $(DESTDIR)$(datarootdir)/clapf

install-sqlite3:
	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/db-sqlite3.sql $(DESTDIR)$(datarootdir)/clapf/db.sql
	$(INSTALL) -d $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/purge-sqlite3.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -d $(DESTDIR)$(localstatedir)/lib/clapf/data
	if [ ! -f "$(DESTDIR)/$(localstatedir)/lib/clapf/data/tokens.sdb" ]; then sqlite3 -batch $(DESTDIR)/$(localstatedir)/lib/clapf/data/tokens.sdb <$(srcdir)/db-sqlite3.sql; \
		chown -R $(CLAPF_USER):$(CLAPF_GROUP) $(DESTDIR)$(localstatedir)/lib/clapf/data/tokens.sdb; fi

install-clapf: clapf
	$(INSTALL) -d $(DESTDIR)$(includedir)
	$(INSTALL) -d $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 clapf.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 cfg.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 misc.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 parser.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 bayes.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 score.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 hash.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 config.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 clapf-config.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 sql.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 errmsg.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 smtpcodes.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 messages.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 mydb.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 list.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 session.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 sig.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -m 0644 av.h $(DESTDIR)$(includedir)/clapf
	$(INSTALL) -d $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(sbindir)
	$(INSTALL) -d $(DESTDIR)$(libdir)
	$(INSTALL) -m 0644 libclapf.a $(DESTDIR)$(libdir)
	$(INSTALL) -m 0755 libclapf.so.$(LIBCLAPF_VERSION) $(DESTDIR)$(libdir)
	(cd $(DESTDIR)$(libdir) && ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so)
	(cd $(DESTDIR)$(libdir) && ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so.$(CLAPF_VERSION))

	$(INSTALL) -d $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/clapf-rrd-create.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/clapf-rrd-graph-oneline.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/clapf-rrd-graph.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/clapf-rrd-update.sh $(DESTDIR)$(libexecdir)/clapf

	$(INSTALL) -d $(DESTDIR)$(localstatedir)/lib/clapf/data
	$(INSTALL) -d -m 755 $(DESTDIR)$(localstatedir)/lib/clapf/queue
	$(INSTALL) -d $(DESTDIR)$(localstatedir)/lib/clapf/blackhole
	$(INSTALL) -d -m 711 $(DESTDIR)$(localstatedir)/lib/clapf/tmp
	$(INSTALL) -d $(DESTDIR)$(localstatedir)/lib/clapf/stat
	$(INSTALL) -d $(DESTDIR)$(localstatedir)/lib/clapf/hold

	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/templates/template.virus $(DESTDIR)$(datarootdir)/clapf

	chown -R $(CLAPF_USER):$(CLAPF_GROUP) $(DESTDIR)$(localstatedir)/lib/clapf
	cat $(srcdir)/util/check_clapf.sh.in | sed -e "s%YOUR_PATH%$(sbindir)%" -e "s%YOUR_QUEUE%$(localstatedir)/lib/clapf/queue%" -e "s%USER%$(CLAPF_USER)%g" > $(srcdir)/util/check_clapf.sh
	$(INSTALL) -m 0755 util/check_clapf.sh $(DESTDIR)$(libexecdir)/clapf
	cat $(srcdir)/util/spamdrop_helper.in | sed -e "s%YOUR_STATE_DIR%$(localstatedir)%" > $(srcdir)/util/spamdrop_helper
	$(INSTALL) -m 0755 util/spamdrop_helper $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 clapf $(DESTDIR)$(sbindir)
	$(INSTALL) -d $(DESTDIR)$(sysconfdir)
	rm -f clapf.conf; make clapf.conf
	if [ ! -f "$(DESTDIR)$(sysconfdir)/clapf.conf" ]; then $(INSTALL) -m 0644 $(srcdir)/clapf.conf $(DESTDIR)$(sysconfdir)/clapf.conf; fi

install-spamsum:
	(cd contrib/spamsum; make install)


install-spamdrop: spamdrop
	$(INSTALL) -m 0755 spamdrop $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 aphash $(DESTDIR)$(bindir)
	(cd $(DESTDIR)$(bindir); ln -sf spamdrop blackhole)

install-splitmbox: splitmbox
	$(INSTALL) -m 0755 splitmbox $(DESTDIR)$(bindir)

install-parsembox:
	$(INSTALL) -m 0755 parsembox $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 spamtest $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/prepare-sql $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/spamstat.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/prepare.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/shrink.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/uribl.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/process_syslog.pl $(DESTDIR)$(libexecdir)/clapf
	cat $(srcdir)/util/db_init_mydb.sh.in | sed -e "s%YOUR_LIBEXECDIR%$(libexecdir)/clapf%" -e "s%YOUR_BINDIR%$(bindir)%" -e "s%YOUR_SHAREDIR%$(datarootdir)/clapf%" > $(srcdir)/util/db_init_mydb.sh
	cat $(srcdir)/util/db_init_mysql.sh.in | sed -e "s%YOUR_LIBEXECDIR%$(libexecdir)/clapf%" -e "s%YOUR_BINDIR%$(bindir)%" -e "s%YOUR_SHAREDIR%$(datarootdir)/clapf%" > $(srcdir)/util/db_init_mysql.sh
	cat $(srcdir)/util/db_init_sqlite3.sh.in | sed -e "s%YOUR_LIBEXECDIR%$(libexecdir)/clapf%" -e "s%YOUR_BINDIR%$(bindir)%" -e "s%YOUR_SHAREDIR%$(datarootdir)/clapf%" > $(srcdir)/util/db_init_sqlite3.sh
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_mydb.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_mysql.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_sqlite3.sh $(DESTDIR)$(libexecdir)/clapf

uninstall:
	rm -f $(DESTDIR)$(bindir)/parsembox
	rm -f $(DESTDIR)$(bindir)/spamtest
	rm -f $(DESTDIR)$(bindir)/splitmbox
	rm -f $(DESTDIR)$(bindir)/blackhole
	rm -f $(DESTDIR)$(bindir)/spamdrop
	rm -f $(DESTDIR)$(bindir)/aphash
	rm -f $(DESTDIR)$(sbindir)/clapf
	rm -f $(DESTDIR)$(libdir)/libclapf.*
	rm -f $(DESTDIR)$(sysconfdir)/clapf.conf
	rm -f $(DESTDIR)$(mandir)/man1/parsembox.1
	rm -f $(DESTDIR)$(mandir)/man1/spamdrop.1
	rm -f $(DESTDIR)$(mandir)/man1/spamtest.1
	rm -f $(DESTDIR)$(mandir)/man1/splitmbox.1
	rm -f $(DESTDIR)$(mandir)/man8/clapf.8

	rm -rf $(DESTDIR)$(libexecdir)/clapf
	rm -rf $(DESTDIR)$(localstatedir)/lib/clapf
	rm -rf $(DESTDIR)$(includedir)/clapf
	rm -rf $(DESTDIR)$(datarootdir)/clapf

clean_db:
	rm -f ham.tmp spam.tmp num_of_spam.tmp num_of_ham.tmp tokens.mydb temp.*

clean:
	rm -f *.o *.a libclapf.so* qcache db.sql clapf clapf.conf parsembox splitmbox spamtest spamdrop spamstat smtpscanner aphash prepare-sql mydb_stat mydb_compress mydb_export
	(cd $(srcdir)/contrib/spamsum; make clean)
	rm -f webui/config.php

dist_clean distclean: clean
	rm -f Makefile config.log config.status clapf-config.h stamp.h clapf.conf
