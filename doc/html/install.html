<html>
<title>Installation</title>
<link rel="stylesheet" type="text/css" href="style.css">
<body bgcolor=white text=darkblue vlink=#AC003A>
<blockquote>

<h1><img src="logo.png"></h1>

<h2>Installation</h2>

<strong>Prerequisites</strong><p/>

Mandatory:<p/>

<ol>
<li>You have a working database. Clapf supports <a href="http://www.mysql.com/">MySQL</a>
and <a href="http://www.sqlite.org/">SQLite3</a>.</li>
<li><a href="http://www.courier-mta.org/maildrop/">Maildrop</a></li>

</ol>

Recommended/optional:<p/>

<ul>
<li>Recommended: install a supported anti-virus application. See the <a href="av.html">
Antivirus support</a> page for the details.</li>
<li>Optional: <a href="http://www.gnu.org/software/gsl/">GNU gsl library</a></li>
</ul>


<strong>Create a dedicated and non-privileged user to run run clapf</strong>

<pre>
groupadd clapf
useradd -g clapf -s /bin/sh -d /var/lib/clapf clapf
usermod -L clapf
</pre>

<strong>Compiling a static build</strong><p/>
If you want a static build, then use the --enable-static-build configure option.
<p/>


<strong>Unpack and compile clapf</strong><p/>

<pre>
tar zxvf clapf-x.y.zzz.tar.gz
cd clapf-x.y.zzz
./configure --with-tokendb=mysql --enable-surbl --enable-blackhole --enable-rbl --enable-lmtp --with-clapf-user=clapf
make
su -c 'make install'
</pre>

Please note that the configure options are saved in the config.log file.<p/>

<ol>

<li>Set up the <a href="tokendatabase.html">database backend</a></li>

<li>Perform the <a href="training.html">initial training</a>.</li>

<li>Users may train the token database using a <a href="training2.html">command line tool, or a cgi form</a>.
Users may train clapf by forwading the email as an attachment to user+ham@domain (if they want to train
with a ham message) or to user+spam@domain (if they want to train with a spam message).<p/>
</li>

<li>Configure postfix to allow the plus (+) sign as a recipient delimiter. Set the following in main.cf,
then issue a <i>postfix reload</i> command.

<pre>
recipient_delimiter = +
</pre>
</li>

<li>
Choose a <a href="group.html">token group type</a>.
</li>

<li>
Add the users to the clapf database:

<pre>
clapf_admin -u joe -e joe@mail.domain.com
</pre>

You may give a specific (and unique) id with the '-i' command line switch, eg.

<pre>
clapf_admin -u joe -e joe@mail.domain.com -i 1002
</pre>

Note 1: the user id has nothing to do with Unix user ids.<br/>
</li>

<li>
Create a directory for each user holding their data for training, eg.:

<pre>
mkdir -p /var/lib/clapf/queue/a/alice
mkdir -p /var/lib/clapf/queue/b/bob
...
mkdir -p /var/lib/clapf/queue/j/joe
...


chown alice:www-data /var/lib/clapf/queue/a/alice
chown bob:www-data /var/lib/clapf/queue/b/bob
...
chown joe:www-data /var/lib/clapf/queue/j/joe
...
</pre>
</li>


<li>
Set up a periodic (ie. using a cron job) purge of the stored messages from the /usr/local/var/clapf/queue directory:

<pre>
1 2 * * * find /var/lib/clapf/queue -type f  -atime +14 -exec rm -f '{}' \;
</pre>

</li>


<li>If you want to use clapf from an LDA refer to 'using spamdrop' otherwise see the 'using the content filter' section</li>


</ol>

<strong>Using spamdrop</strong><p/>

<ol>

<li>Setup the .forward file:

<pre>
|/usr/local/bin/maildrop
</pre>
</li>


<li>Configure the global maildroprc file (/etc/maildroprc):

<pre>
xfilter "/usr/local/bin/spamdrop -p"
to "Mailbox"
</pre>

The first line passes the email to spamdrop, then it reads the email the put some stuff to the email header.
If it's a spam, spamdrop inserts the "<i>X-Clapf-spamicity: Yes</i>" header line and may mark the Subject
line too. After downloading the email via POP3/IMAP4/... you can sort your spam to the junk folder or do
whatever you want with it. Of course, a more complex setup is also possible with maildrop, eg. moving spam
to a different folder, etc.<p/>

Per user maildrop configuration is also possible with the users' <i>~/.mailfilter</i> file
and you may configure using Maildir instead of Mailbox.</li>


</ol>



<strong>Using the content filter</strong><p/>

<ol>

<li>Start the clapf daemon:

<pre>
/usr/local/bin/clapf -d
</pre>
</li>

<li>Edit /etc/postfix/master.cf and the following lines</li>

<pre>
127.0.0.1:10026     inet  n      -      n      -      10      smtpd -o content_filter=
					-o receive_override_options=no_address_mappings
</pre>

<li>Edit /etc/postfix/main.cf and add the following lines</li>

<pre>
content_filter = lmtp:[127.0.0.1]:10025
default_destination_concurrency_limit = 10
smtpd_recipient_limit = 128
lmtp_send_xforward_command = yes
smtp_send_xforward_command = yes
smtpd_authorized_xforward_hosts = 127.0.0.0/8
</pre>

If you want SMTP local delivery instead of LMTP, then omit the <i>--enable-lmtp</i>
configure option and use the following <i>content_filter</i> reference:

<pre>
content_filter = smtp:[127.0.0.1]:10025
</pre>


<li>Issue the <i>postfix reload</i> command</li>

<li>Further notes:<p/>

Clapf can handle a finite number of recipients, 128 by default. If you want
more recipients in a single session edit MAX_RCPT_TO in config.h then (re)compile clapf
and adjust the <i>smtpd_recipient_limit</i> variable in main.cf. If you want
less than 128 you should only adjust the <i>smtpd_recipient_limit</i> variable in main.cf.<p/>

Please note that if you want to increase the concurrency, modify the
<b>default_destination_concurrency_limit</b> in main.cf, the <b>127.0.0.1:10026</b>
entry in master.cf and the <b>max_connections</b> in clapf.conf,
then reload postfix.

The <b>max_connections</b> should be greater than default_destination_concurrency_limit:<p/>

max_connections &gt;= default_destination_concurrency_limit + 1<p/>
</li>

</ol>




<strong>Handling virtual users</strong><p/>

Read on how to <a href="virtual.html">set up virtual users</a> in clapf.
<p/>


<strong>What next?</strong><p/>

You may be interested in the <a href="blackhole.html">blackhole (or minefield)</a> feature,
making some <a href="stats.html">statistics</a>, <a href="surbl.html">SURBL</a> support, or some
of the <a href="antispam.html">anti-spam details</a>.
<p/>

If you use a language other than iso-8859-2 you should <strong>review and adjust</strong>
the ijc.h file for junk characters and trans.h for valid characters. If you edit these files
I will include them in the source tree to make them available for others.<p/>

<center><a href="index.html">home</a></center><p>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1610427-1";
urchinTracker();
</script>


</body></html>
