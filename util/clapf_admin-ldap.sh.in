#!/bin/sh
###
### clapf_admin.sh
###

if [ $# -lt 2 ]; then
	echo; echo "usage: $0 <action> <uid> <gid> <username> <realname> <encrypted password by slappasswd> <email address> <domain> <policy group id> <basedn>"; echo
	echo "eg: $0 add 1001 1001 jim 'Jim Bim' '"'{SSHA}iHtdvh+qyBb5BCYblly9qEQ1BHTcoOqA'"' jim@aaaa.fu aaaa.fu 0 ou=clapfusers,dc=yourdomain,dc=com"
	exit 1;
fi

action=$1
uid=$2
gid=$3
username=$4
realname=$5
encrypted_password=$6
email=$7
domain=$8
poliy_group_id=$9
basedn=$10


### check parameters ###

# some numeric fields

x=`echo $uid | tr -cd [:digit:]`
if [ "$x" != "$uid" ]; then echo "invalid uid: $uid"; exit; fi

x=`echo $gid | tr -cd [:digit:]`
if [ "$x" != "$gid" ]; then echo "invalid gid: $gid"; exit; fi

x=`echo $poliy_group_id | tr -cd [:digit:]`
if [ "$x" != "$poliy_group_id" ]; then echo "invalid policy group id: $poliy_group_id"; exit; fi

# username may contain alphanumeric characters

x=`echo $username | tr -cd [:alnum:]`
if [ "$x" != "$username" ]; then echo "invalid username: $username"; exit; fi

x=`echo $realname | tr -cd [:alnum:][@_\.\ ]`
if [ "$x" != "$realname" ]; then echo "invalid realname: $realname"; exit; fi

# email and domain may contain alphanumeric characters + '.', '@', '-', '_'

x=`echo $email | tr -cd -- -[:alnum:][@_.]`
if [ "$x" != "$email" ]; then echo "invalid email: $email"; exit; fi

x=`echo $domain | tr -cd -- -[:alnum:][@_.]`
if [ "$x" != "$domain" ]; then echo "invalid domain: $domain"; exit; fi

# encrypted password may contain alphanumeric characters + '$', '/', '.'

x=`echo $encrypted_password | tr -cd [:alnum:][\/\$\.\+\{\}]`
if [ "$x" != "$encrypted_password" ]; then echo "invalid encrypted password: $encrypted_password"; exit; fi





if test $# -eq 9 && test "$action" = "add" ; then
	echo "dn: cn=$username,$basedn";
	echo "sn: $realname";
	echo "objectClass: top";
	echo "objectClass: person";
	echo "objectClass: qmailUser";
	echo "objectClass: qmailGroup";
	echo "objectClass: clapfUser";
	echo "uid: $uid";
	echo "clapfgid: $gid";
	echo "mail: $email";
	echo "mailAlternateAddress:";
	echo "mailMessageStore: x";
	echo "filtersender:";
	echo "blackList:";
        echo "domain: $domain";
	echo "policyGroupId: $poliy_group_id";
	echo "isAdmin: 0";
	echo "userPassword: $encrypted_password";
	echo;

fi

