0. Attention to all current clapf users storing user data in either
MySQL or SQLite3 table (LDAP users are not affected)!

From 17th, May 2009, the database schemas are modified. I have written
an sql script to update your user table. See util/db-update-mysql.sql
or (...-sqlite3.sql).

Basically it creates a temporary table 'bbbb' from the user table,
then creates the 't_email' table and copies email addresses there,
then renames 'user' to 'user_old', and 'bbbb' to 'user'.

To execute it, issue the following command _after_ you have backed up
your clapf database:

mysql -u clapf -p clapf < util/db-update-mysql.sql
(or sqlite /var/lib/clapf/data/tokens.sdb < util/db-update-sqlite3.sql)




1. Always backup your current clapf.conf file and the clapf database.

2. Do a "make install" to replace your old binaries, and other stuff.

3. If you already have a clapf.conf file "make install" will not
update it, you should review the newer config file and modify it
according to your settings.

If you store your user data in SQL:
-----------------------------------

4. Create the t_policy table, then update the user table according 
to the new db.sql schema:

alter table user add column policy_group int(4) default 0;
alter table user drop column action;
alter table user drop column pagelen;

5. Make sure that your t_policy table has the store_metadata
field. If it's not than apply this statement:

alter table t_policy add column store_metadata tinyint default 0;

6. Make sure you have the t_black_list table, if not then apply
this statement:

create table if not exists t_black_list (
        uid int unsigned not null primary key,
        blacklist blob default null
);

create index t_black_list_idx on t_black_list (uid);


7. Make sure your users exist in t_white_list and t_black_list tables.
If not, then create such an SQL commands:

insert t_white_list (uid, whitelist) values(0, '');
insert t_white_list (uid, whitelist) values(1, '');
insert t_white_list (uid, whitelist) values(2, '');
....

insert t_black_list (uid, blacklist) values(0, '');
insert t_black_list (uid, blacklist) values(1, '');
insert t_black_list (uid, blacklist) values(2, '');
....

Of course, you can script this :-)


If you store your user data in LDAP:
------------------------------------

7. Update (=overwrite) the LDAP schemas using ldap/clapf-policy.schema
and ldap/qmail.schema.


