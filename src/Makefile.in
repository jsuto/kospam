SHELL = @SHELL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
srcdir = @srcdir@
sysconfdir = @sysconfdir@
mandir = @mandir@
datarootdir = @datarootdir@
localstatedir = @localstatedir@

CC = @CC@
CFLAGS = @CFLAGS@ @CPPFLAGS@
DEFS = @defs@
INCDIR = -I. -I.. @INCDIR@ @sql_includes@
LIBDIR = -L. @LIBDIR@ @LDFLAGS@
LIBS = @LIBS@ @sql_libs@
OBJS = @OBJS@
SQL_OBJS = @sql_obj@
RUNNING_USER = @RUNNING_USER@
RUNNING_GROUP = `@id_bin@ -gn $(RUNNING_USER)`

PILER_VERSION=0
PILER_REVISION=1
PILER_RELEASE=1
LIBCLAPF_VERSION=$(PILER_VERSION).$(PILER_REVISION).$(PILER_RELEASE)

MAKE = `which make`

INSTALL = @INSTALL@

all: libclapf.a clapf clapfconf spamdrop splitmbox
install: install-clapf


clapf: clapf.c libclapf.a
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $< -lclapf $(LIBS) $(LIBDIR) @LDFLAGS@ @libclamav_extra_libs@

libclapf.a: $(OBJS) $(SQL_OBJS)
	ar cr libclapf.a $(OBJS) $(SQL_OBJS)
	ranlib libclapf.a
	$(CC) -shared -o libclapf.so.$(LIBCLAPF_VERSION) $(OBJS) $(SQL_OBJS)
	ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so
	ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so.$(PILER_VERSION)


clapfconf: clapfconf.c libclapf.a
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $< -lclapf $(LIBS) $(LIBDIR)

spamdrop: spamdrop.c libclapf.a
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $< -lclapf $(LIBS) $(LIBDIR) @LDFLAGS@

splitmbox: splitmbox.c libclapf.a
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $< -lclapf $(LIBS) $(LIBDIR) @LDFLAGS@

%.o: $(srcdir)/%.c
	$(CC) $(CFLAGS) -fPIC $(INCDIR) $(DEFS) -c $< -o $@


install-clapf:
	$(INSTALL) -m 0644 libclapf.a $(DESTDIR)$(libdir)
	$(INSTALL) -m 0755 libclapf.so.$(LIBCLAPF_VERSION) $(DESTDIR)$(libdir)
	(cd $(DESTDIR)$(libdir) && ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so)
	(cd $(DESTDIR)$(libdir) && ln -sf libclapf.so.$(LIBCLAPF_VERSION) libclapf.so.$(PILER_VERSION))

	$(INSTALL) -m 0755 clapf $(DESTDIR)$(sbindir)
	$(INSTALL) -m 0755 clapfconf $(DESTDIR)$(sbindir)
	$(INSTALL) -m 0755 spamdrop $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 splitmbox $(DESTDIR)$(bindir)

clean:
	rm -f *.o *.a libclapf.so* clapf clapfconf spamdrop splitmbox

distclean: clean
	rm -f Makefile

