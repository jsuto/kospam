SHELL = @SHELL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
libexecdir = @libexecdir@
srcdir = @srcdir@
sysconfdir = @sysconfdir@
mandir = @mandir@
datarootdir = @datarootdir@
localstatedir = @localstatedir@

CC = @CC@
CFLAGS = @CFLAGS@ @CPPFLAGS@
DEFS = @defs@
INCDIR = -I. @INCDIR@ @mysql_includes@
LIBDIR = @LIBDIR@ @mysql_libs@
LIBS = @LIBS@
LDAP_LIBS = @ldap_libs@
OBJS = @OBJS@
USER_OBJ = @user_obj@
MYSQL_OBJS = @mysql_obj@

INSTALL = @INSTALL@

all: clapf splitmbox @cgi@ @parsembox@ @passmail@ @train@ @qcache@ @test@
install: install-clapf install-splitmbox @parsembox_install@ @passmail_install@ @train_install@ @qcache_install@ @db_install@

clapf.conf:
	sed -e 's%pidfile=.*%pidfile=$(localstatedir)/run/clapf.pid%' \
	    -e 's%clamd_socket=.*%clamd_socket=$(localstatedir)/run/clamav/clamd.ctl%' \
	    -e 's%tokensfile=.*%clamd_socket=$(localstatedir)/lib/clapf/tokens.cdb%' \
	    -e 's%blackhole_path=.*%clamd_socket=$(localstatedir)/lib/clapf/blackhole%' \
	    -e 's%mysqlsocket=.*%mysqlsocket=$(localstatedir)/run/mysqld/mysqld.sock%' \
	    -e 's%sqlite3=.*%sqlite3=$(localstatedir)/lib/clapf/tokens.sdb%' \
	    -e 's%saved_ham_path=.*%saved_ham_path=$(localstatedir)/lib/clapf/saved/ham%' \
	    -e 's%saved_spam_path=.*%saved_spam_path=$(localstatedir)/lib/clapf/saved/spam%' \
	    -e 's%spam_quarantine_dir=.*%spam_quarantine_dir=$(localstatedir)/lib/clapf/spamquarantine%' \
	    -e 's%workdir=.*%workdir=/tmp%' <$(srcdir)/example.conf >$@

clapf: % : %.o $(OBJS) $(MYSQL_OBJS)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR) @LDFLAGS@

parsembox: % : %.o misc.o decoder.o parser.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

spamdrop: % : %.o bayes.o $(OBJS) $(MYSQL_OBJS)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

splitmbox: % : %.o misc.o decoder.o parser.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

spamcgi usercgi traincgi trainlogcgi statcgi: % : %.o $(OBJS) $(USER_OBJ) $(MYSQL_OBJS)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

aphash: % : %.o misc.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^

prepare-sql: % : %.o misc.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^

spam-fwd-train spamstat clapf_admin: % : %.o $(OBJS) $(MYSQL_OBJS)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

smapd:	% : %.o $(OBJS) $(MYSQL_OBJS)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR) -lssl -lcrypto -ldl -lpthread

train: % : %.o spamdrop spam-fwd-train spamstat clapf_admin aphash prepare-sql
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ train.o $(OBJS) $(MYSQL_OBJS) $(LIBS) $(LIBDIR) @LDFLAGS@

test:
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -c $(srcdir)/bayes.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -c $(srcdir)/black.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -c $(srcdir)/hash.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -c $(srcdir)/parser.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -c $(srcdir)/rbl.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -DDEBUG -o spamtest $(srcdir)/test.c $(OBJS) $(MYSQL_OBJS) $(LIBS) $(LIBDIR) @LDFLAGS@

passmail: % : %.o misc.o cfg.o smtp.o $(USER_OBJ)
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ $(LIBS) $(LDAP_LIBS) $(LIBDIR)

qcache: qs.o misc.o cfg.o qcache.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o qs $^ $(LIBS) -lpthread $(LIBDIR)

%.o: $(srcdir)/%.c
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -c $< -o $@

install-mysql-new:
	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/db-new.sql $(DESTDIR)$(datarootdir)/clapf/db.sql

install-mysql-old:
	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/db-old.sql $(DESTDIR)$(datarootdir)/clapf/db.sql

install-sqlite3:
	$(INSTALL) -d $(DESTDIR)$(datarootdir)/clapf
	$(INSTALL) -m 0644 $(srcdir)/db-sqlite3.sql $(DESTDIR)$(datarootdir)/clapf/db.sql
	if [ ! -f "$(DESTDIR)/opt/av/tokens.sdb" ]; then sqlite3 -batch $(DESTDIR)/opt/av/tokens.sdb <$(srcdir)/db-sqlite3.sql; fi

install-clapf: clapf
	$(INSTALL) -d $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 util/check_clapf.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 clapf $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(sysconfdir)
	if [ ! -f "$(DESTDIR)$(sysconfdir)/clapf.conf" ]; then $(INSTALL) -m 0644 $(srcdir)/example.conf $(DESTDIR)$(sysconfdir)/clapf.conf; fi
	$(INSTALL) -d $(DESTDIR)$(mandir)/man8
	$(INSTALL) -m 0644 $(srcdir)/doc/man/clapf.8 $(DESTDIR)$(mandir)/man8

install-spamdrop: spamdrop
	$(INSTALL) -m 0755 spamdrop $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
	$(INSTALL) -m 0644 $(srcdir)/doc/man/spamdrop.1 $(DESTDIR)$(mandir)/man1

install-splitmbox: splitmbox
	$(INSTALL) -m 0755 splitmbox $(DESTDIR)$(bindir)

install-parsembox:
	$(INSTALL) -m 0755 parsembox $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 spamtest $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/prepare-sql $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/stat/spamstat.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/createcdb.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/mysql2cdb.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/prepare.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/shrink.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/perl/uribl.pl $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_cdb.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_mysql.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/db_init_sqlite3.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -m 0755 $(srcdir)/util/user2sq.sh $(DESTDIR)$(libexecdir)/clapf
	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
	$(INSTALL) -m 0644 $(srcdir)/doc/man/parsembox.1 $(DESTDIR)$(mandir)/man1
	$(INSTALL) -m 0644 $(srcdir)/doc/man/spamtest.1 $(DESTDIR)$(mandir)/man1

install-train:
	$(INSTALL) -m 0755 spamdrop $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 spam-fwd-train $(DESTDIR)$(bindir)
	ln -sf spam-fwd-train $(DESTDIR)$(bindir)/ham-fwd-train
	$(INSTALL) -m 0755 spamstat $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 aphash $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 clapf_admin $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
	$(INSTALL) -m 0644 $(srcdir)/doc/man/train.1 $(DESTDIR)$(mandir)/man1

install-qcache:
	$(INSTALL) -m 0755 qs $(DESTDIR)$(bindir)

install-passmail:
	$(INSTALL) -m 0755 passmail $(DESTDIR)$(bindir)
	$(INSTALL) -m 0644 $(srcdir)/doc/man/passmail.1 $(DESTDIR)$(mandir)/man1

clean_db:
	rm -f CDBFILE.* ham.tmp spam.tmp num_of_spam.tmp num_of_ham.tmp tokens*.cdb temp.*

clean:
	rm -f *.o *.a smapd qs db.sql clapf clapf.conf parsembox splitmbox spamtest spamdrop train spamcgi traincgi trainlogcgi usercgi statcgi passmail spam-fwd-train spamstat aphash clapf_admin prepare-sql

dist_clean distclean: clean
	rm -f Makefile config.log config.status clapf-config.h stamp.h clapf.conf
