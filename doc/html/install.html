<html>
<title>Installation</title>
<link rel="stylesheet" type="text/css" href="style.css">
<body bgcolor=white text=darkblue vlink=#AC003A>
<blockquote>

<h1><img src="logo.png"></h1>

<h2>Installation</h2>

<strong>Prerequisites</strong><p/>

Install postfix 2.x: <a href="http://www.postfix.org/">http://www.postfix.org/</a>.
Clapf was originally designed to work with postfix but you may use it with any
product capable of LMTP/SMTP communication. Clapf can be run from the maildrop LDA as
well as with any SMTP server. Appliance mode is also possible.<p/>

I strongly recommend you to install one of the supported antivirus products:<p/>

<ul>
<li>clamav-0.90+: <a href="http://www.clamav.net/">http://www.clamav.net/</a></li>
<pre>
     Under FreeBSD I recommend you to compile clamav with the following options:
     --disable-cr --disable-pthreads --disable-bzip2 --enable-bigstack
</pre>

<li>AVG Linux: <a href="http://free.grisoft.com/">http://free.grisoft.com/</a></li>
<li>avast!: <a href="http://www.avast.com/">http://www.avast.com/</a></li>
<li>Kaspersky: <a href="http://www.kaspersky.com/">http://www.drweb.com/</a></li>
<li>Dr.Web: <a href="http://www.drweb.com/">http://www.drweb.com/</a></li>
</ul>

If you want to use the antispam module, decide what database backend to use.
Install the <a href="http://www.corpit.ru/mjt/tinycdb.html">tinycdb package</a>
in case of the CDB backend or a current <a href="http://www.mysql.com/">MySQL</a>
server.<p/>

Optional packages:<p/>

<ul>
<li>GNU gsl library: <a href="http://www.gnu.org/software/gsl/">http://www.gnu.org/software/gsl/</a></li>
<li>Maildrop: <a href="http://www.courier-mta.org/maildrop/">http://www.courier-mta.org/maildrop/</a></li>
</ul>


<strong>Install</strong><p>

<ol>
<li>edit parameters in config.h (if you want)</li>

<li><pre>./configure</pre></li>

    The antispam module is turned on and no antivirus engine is selected by default.<p/>

    --enable-libclamav: build <a href="http://www.clamav.net/">libclamav</a> antivirus support<p/>

    --enable-clamd: build <a href="http://www.clamav.net/">clamd</a> antivirus support<p/>

    --enable-avg: build <a href="http://free.grisoft.com/">AVG Linux</a> antivirus support<p/>

    --enable-avast: build <a href="http://www.avast.com/">avast!</a> antivirus support<p/>

    --enable-kav: build <a href="http://www.kaspersky.com/">Kaspersky Anti-Virus for File and Mail Servers</a> support<p/>

    --enable-drweb: build <a href="http://www.drweb.com/">Dr.Web</a> antivirus support.<p/>

    --enable-blackhole: build the blackhole feature<p/>

    --enable-cgi: build the web interface to train the database (of course need a working web server)<p/>

    --enable-hash-db: build the memory based hash database (expect a few MB extra memory per processes)<p/>

    --enable-case: use case sensitive tokens<p/>

    --enable-mysql: add <a href="http://www.mysql.com/">MySQL</a> support<p/>

    --enable-surbl: build <a href="surbl.html">SURBL</a> support<p/>

    --enable-blackhole: build the <a href="blackhole.html">blackhole</a> feature (MySQL is needed for this)<p/>

    --with-userdb[=ldap|mysql]: use either LDAP or MySQL stored <a href="user.html">user preferences</a> data<p/>

    --with-tokendb[=cdb|mysql]: use either CDB or MySQL backend<p/>

    <pre>(note: if you have MySQL installed, the command line training utility is automatically built)</pre>

    --disable-antispam: do not build the antispam feature (note: disabling *both* antivirus and antispam support makes no sense)<p/>





    You may try to set CPPFLAGS and LDFLAGS if you have some headers/libraries on non-standard places, eg.<p/>

    <pre>CPPFLAGS=-I/usr/local/mysql/include LDFLAGS=-L/usr/local/mysql/lib ./configure .....</pre>

<li><pre>make clean all</pre>

<li><pre>su -c 'make install'</pre>

This copies binaries, some shell and Perl scripts to $PREFIX/bin, example.conf to $PREFIX/etc/clapf.conf as well as the manual
pages to $PREFIX/man. The cgi scripts must be manually copied to the cgi-bin directory.<p/>

<li>create a dedicated group and user for clapf such as "av"

   <pre>groupadd av; useradd -g av -d /opt/av -s /bin/sh av</pre>

<li>lock the user out:

   <pre>usermod -L av</pre>

<li>create directories for clapf</li>
<pre>
mkdir -p /opt/av/quarantine
mkdir /opt/av/spamquarantine
mkdir /opt/av/tmp
mkdir /opt/av/queue
mkdir -p /opt/av/saved/ham
mkdir /opt/av/saved/spam
chown -R av:av /opt/av
chmod 711 /opt/av
chmod 770 /opt/av/spamquarantine
chgrp httpd /opt/av/spamquarantine
</pre>
where 'httpd' is the group of the user running your web server.<p>

If you plan to put clapf into a chroot jail make sure to create a /tmp directory there.<p>

<li>Create the token database. Read the <a href="tokendatabase.html">token database</a> paper.<p>


<li>Now look and edit the configuration file called /usr/local/etc/clapf.conf.
You may found the default values in it along with a short description.<p>

<li>start the filter application:

<pre>
su av -c 'export TMPDIR=/opt/av; /usr/local/bin/clapf -c /usr/local/etc/clapf.conf &'
</pre>

Possible switches:
<pre>
      -V: show version and exit
      -c: configuration file
</pre>


</ol>

The util/check_clapf.sh script is planned to run regularly to check whether clapf is
running and restart it if necessary.<p>

Notice the following (or similar) messages in syslog (typically /var/log/maillog):<p>

<pre>
Oct 12 13:26:43 thorium clapf[15851]: reloaded config: /usr/local/etc/clapf.conf
Oct 12 13:26:43 thorium clapf[15851]: clapf 0.3.xx starting
Oct 12 13:26:45 thorium clapf[15851]: reloaded with 40544 viruses
</pre>
<p>


<strong>Configure postfix</strong><p>

<ol>
<li>add the following line to main.cf:

<pre>
content_filter = lmtp:[127.0.0.1]:10025
default_destination_concurrency_limit = 10
smtpd_recipient_limit = 128
</pre>

<li>add the following lines to master.cf:

<pre>
127.0.0.1:10026     inet  n      -      n      -      10      smtpd -o content_filter=
					-o receive_override_options=no_address_mappings
</pre>

<li>restart postfix

<pre>
postfix reload
</pre>

</ol>
<p>

Clapf can handle a finite number of recipients, 128 by default. If you want
more recipients in a single session edit MAX_RCPT_TO in config.h then (re)compile clapf
and adjust the <i>smtpd_recipient_limit</i> variable in main.cf. If you want
less than 128 you should only adjust the <i>smtpd_recipient_limit</i> variable in main.cf.<p>

Please note that if you want to increase the concurrancy, modify the
<b>default_destination_concurrency_limit</b> in main.cf, the <b>127.0.0.1:10026</b>
entry in master.cf and the <b>max_connections</b> in clapf.conf,
then reload postfix.<p>

The <b>max_connections</b> should be greater than default_destination_concurrency_limit.<br>
max_connections &gt;= default_destination_concurrency_limit + 1<p>

If you use a language other than iso-8859-2 you should <strong>review and adjust</strong>
the ijc.h file for junk characters and trans.h for valid characters. If you edit these files
I will include them in the source tree to make them available for others.<p/>

<center><a href="index.html">home</a></center><p>


</blockquote>
</body></html>
