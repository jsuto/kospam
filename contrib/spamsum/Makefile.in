SHELL = @SHELL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
srcdir = @srcdir@
sysconfdir = @sysconfdir@
mandir = @mandir@
datarootdir = @datarootdir@
localstatedir = @localstatedir@

CC = @CC@
CFLAGS = @CFLAGS@ @CPPFLAGS@
DEFS = @defs@
INCDIR = -I. -I../.. @INCDIR@ @mysql_includes@
LIBDIR = -L. @LIBDIR@ @LDFLAGS@
LIBS = @LIBS@ @mysql_libs@
LDAP_LIBS = @ldap_libs@
OBJS = edit_dist.o spamsum.o

SPAMSUM_VERSION=0
SPAMSUM_REVISION=1
SPAMSUM_RELEASE=1
LIBSPAMSUM_VERSION=$(SPAMSUM_VERSION).$(SPAMSUM_REVISION).$(SPAMSUM_RELEASE)

INSTALL = @INSTALL@

all: spamsum ssum

spamsum:	% : %.o $(OBJS)
	ar cr libspamsum.a $(OBJS)
	ranlib libspamsum.a
	$(CC) -shared -Wl,-soname,libspamsum.so.$(SPAMSUM_VERSION) -o libspamsum.so.$(LIBSPAMSUM_VERSION) $(OBJS) $(MYSQL_OBJS) $(LIBS) $(LDAP_LIBS) @LDFLAGS@
	ldconfig -n .
	ln -sf libspamsum.so.$(SPAMSUM_VERSION) libspamsum.so

%.o: $(srcdir)/%.c
	$(CC) $(CFLAGS) -fPIC $(INCDIR) $(DEFS) -c $< -o $@

ssum:	% : %.o
	$(CC) $(CFLAGS) $(INCDIR) $(DEFS) -o $@ $^ -lspamsum $(LIBDIR) @LDFLAGS@

install:
	$(INSTALL) -d $(DESTDIR)$(libdir)
	$(INSTALL) -m 0644 libspamsum.a $(DESTDIR)$(libdir)
	$(INSTALL) -m 0755 libspamsum.so.$(LIBSPAMSUM_VERSION) $(DESTDIR)$(libdir)
	(cd $(DESTDIR)$(libdir) && ln -sf libspamsum.so.$(LIBSPAMSUM_VERSION) libspamsum.so)
	(cd $(DESTDIR)$(libdir) && ln -sf libspamsum.so.$(LIBSPAMSUM_VERSION) libspamsum.so.$(SPAMSUM_VERSION))
	$(INSTALL) -d $(DESTDIR)$(libexecdir)
	$(INSTALL) -m 0755 $(srcdir)/ssum $(DESTDIR)$(libexecdir)/clapf/spamsum

clean:
	rm -f *.o *.a *.so* ssum

dist_clean distclean: clean
	rm -f Makefile
