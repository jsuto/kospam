AC_INIT(clapf.c)
AM_CONFIG_HEADER(clapf-config.h)

dnl Checks for programs.
AC_PROG_CC
AM_PROG_CC_STDC
AC_PROG_MAKE_SET
AC_PROG_INSTALL

dnl Checks for header files.
AC_HEADER_STDC
AC_CHECK_HEADERS(sys/socket.h sys/time.h syslog.h signal.h ctype.h unistd.h)


AC_SUBST(defs)
AC_SUBST(INCDIR)
AC_SUBST(LIBDIR)
AC_SUBST(OBJS)
AC_SUBST(CLAPF_USER)
AC_SUBST(parsembox)
AC_SUBST(clapfstore)
AC_SUBST(clapfstore_install)
AC_SUBST(cgi)
AC_SUBST(parsembox_install)
AC_SUBST(qcache)
AC_SUBST(spamdrop)
AC_SUBST(spamdrop_install)
AC_SUBST(preparesql)
AC_SUBST(qcache_install)
AC_SUBST(test)
AC_SUBST(mysql_includes)
AC_SUBST(mysql_libs)
AC_SUBST(user_obj)
AC_SUBST(ldap_libs)
AC_SUBST(mysql_obj)
AC_SUBST(store_obj)
AC_SUBST(db_install)
AC_SUBST(spamsum_libs)
AC_SUBST(spamsum)

have_libclamav="no"
have_clamd="no"
have_avg="no"
have_avast="no"
have_kav="no"
have_drweb="no"

have_antivirus="no"
have_antispam="no"
have_blackhole="no"
have_cgi="no"
have_spamdrop="no"
have_mysql="no"
have_sqlite3="no"
have_ldap="no"
have_rbl="no"
have_all_received="no"
have_gsl="no"
have_store="no"
have_whitelist="no"
have_case="no"

have_static_build="no"

antispam_libs=""
defs=""
objs=""
user_obj=""
mysql_obj=""
ldap_libs=""
sqlite3_libs=""
spamsum_libs=""
os=`uname -s`
keep_old_token_format="no"

want_outgoing_smtp="no"
want_language_detection="no"


dnl static build

AC_ARG_ENABLE(static-build,
          [  --enable-static-build   build statically linked executables (default: dynamically linked)], have_static_build=$enableval, have_static_build="no")


dnl clamav

AC_ARG_ENABLE(libclamav,
	[  --enable-libclamav      build libclamav antivirus support], want_clamav=$enableval, want_clamav="no")

   if test "$want_clamav" = "yes"; then

	AC_CHECK_HEADERS(clamav.h, have_libclamav=yes, have_libclamav=no)
	AC_HAVE_LIBRARY(clamav, AC_CHECK_LIB(clamav, cl_scanfile, have_libclamav=yes, have_libclamav=no))

	if test "$have_libclamav" = "no"; then
   	   echo "clamav not found";
   	   exit 1;
	fi

        have_antivirus="yes"
   fi

dnl clamd


AC_ARG_ENABLE(clamd,
	[  --enable-clamd          build clamd antivirus support], want_clamd=$enableval, want_clamd="no")
   if test "$want_clamd" = "yes"; then
      have_clamd="yes"
      have_antivirus="yes"
   fi


dnl avg

AC_ARG_ENABLE(avg,
          [  --enable-avg            build AVG Linux antivirus support], want_avg=$enableval, want_avg="no")

    if test "$want_avg" = "yes"; then
       have_avg="yes"
       have_antivirus="yes"
    fi

dnl avast!

AC_ARG_ENABLE(avast,
         [  --enable-avast          build avast! antivirus support], want_avast=$enableval, want_avast="no")

    if test "$want_avast" = "yes"; then
       have_avast="yes"
       have_antivirus="yes"
    fi


dnl KAV

AC_ARG_ENABLE(kav,
         [  --enable-kav            build Kaspersky antivirus support], want_kav=$enableval, want_kav="no")

    if test "$want_kav" = "yes"; then
       have_kav="yes"
       have_antivirus="yes"
    fi



dnl Dr.Web

AC_ARG_ENABLE(drweb,
         [  --enable-drweb          build Dr.Web antivirus support], want_drweb=$enableval, want_drweb="no")

    if test "$want_drweb" = "yes"; then
       have_drweb="yes"
       have_antivirus="yes"
    fi


dnl use whitelist

AC_ARG_ENABLE(whitelist,
	[  --enable-whitelist      use whitelist], want_whitelist=$enableval, want_whitelist="no")

   if test "$want_whitelist" = "yes"; then
      have_whitelist="yes"
   fi


dnl use case sensitive tokens

AC_ARG_ENABLE(case,
        [  --enable-case           use case sensitive tokens], want_case=$enableval, want_case="no")

   if test "$want_case" = "yes"; then
      have_case="yes"
   fi


dnl antispam feature

dnl AC_ARG_ENABLE(antispam,
dnl       [  --disable-antispam      do not build antispam support], want_antispam=$enableval, want_antispam="yes")

dnl  if test "$want_antispam" = "yes"; then

    dnl math library

    AC_CHECK_HEADERS(math.h, have_math=yes, have_math=no)
    AC_HAVE_LIBRARY(m, AC_CHECK_LIB(m, fabs), have_math=yes, ""; exit)

    dnl have_antispam="yes"

    antispam_libs="-lm"

    dnl mysql database

    dnl AC_CHECK_PROG(MYSQL_CONFIG, mysql_config, yes)

    dnl if test x$MYSQL_CONFIG = xyes; then
    dnl   have_mysql="yes"
    dnl fi

    dnl ldap database

    AC_CHECK_HEADERS(ldap.h, have_ldap=yes, echo "ldap.h is not found")
    AC_HAVE_LIBRARY(ldap, AC_CHECK_LIB(ldap, ldap_simple_bind_s, have_ldap=yes, echo "libldap.so is not found"; have_ldap=no))


    dnl (su)rbl support

    AC_ARG_ENABLE(rbl,
          [  --enable-rbl            use the (SU)RBL database], want_rbl=$enableval, want_rbl="no")

    if test "$want_rbl" = "yes"; then
       have_rbl="yes"
    fi


    dnl whether to check all "Received: from" lines having IP-addresses

    AC_ARG_ENABLE(all-received,
          [  --enable-all-received   check all the IP-addresses from "Received: from ..." lines against blacklists], want_all_received=$enableval, want_all_received="no")

    if test "$want_all_received" = "yes"; then
       have_all_received="yes"
    fi


    dnl token format

    AC_ARG_ENABLE(old-format,
          [  --enable-old-format     use old token format], keep_old_token_format=$enableval, keep_old_token_format="no")


    dnl gsl support

    AC_CHECK_HEADERS(gsl/gsl_cdf.h, have_gsl=yes, echo "gsl_cdf.h is not found")

    if test "$have_gsl" = "yes"; then
       defs="$defs -DHAVE_GSL"
       gsl_libs="-lgslcblas -lgsl"
    fi


    dnl the blackhole feature

    AC_ARG_ENABLE(blackhole,
          [  --enable-blackhole      build the blackhole feature], want_blackhole=$enableval, want_blackhole="no")

    if test "$want_blackhole" = "yes"; then
       have_blackhole="yes"
       echo "So you've selected the blackhole feature ... good"
    fi


    dnl the cgi training interface

    AC_ARG_ENABLE(cgi,
          [  --enable-cgi            build the web interface to train the database], want_cgi=$enableval, want_cgi="no")

    if test "$want_cgi" = "yes"; then

       have_cgi="yes"

    fi


AC_ARG_WITH(userdb,
[  --with-userdb[[=ldap|mysql]]      use either ldap or mysql database holding user data (default: none)],[
  if test "$withval" != "no" -a "$withval" != "yes"; then
    USERDB=$withval
  fi
])


AC_ARG_WITH(tokendb,
[  --with-tokendb[[=mysql|sqlite3]]      use either mysql or sqlite3 database holding tokens (default: none)],[
  if test "$withval" != "no" -a "$withval" != "yes"; then
    TOKENDB=$withval
  fi

  have_antispam="yes"

  parsembox="parsembox"
  parsembox_install="install-parsembox"

  if test "$withval" = "sqlite3"; then
    AC_CHECK_HEADERS(sqlite3.h, have_sqlite3=yes, echo "sqlite3.h is not found")

    AC_HAVE_LIBRARY(sqlite3, AC_CHECK_LIB(sqlite3, sqlite3_open, have_sqlite3=yes, have_sqlite3=no))

      if test "$have_sqlite3" = "no"; then
           echo "sqlite3 not found";
           exit 1;
      fi

    have_spamdrop="yes"
    parsembox="$parsembox"
    preparesql="prepare-sql aphash clapf_admin"
    spamdrop="spamdrop"
    spamdrop_install="install-spamdrop"

    test="test"
  fi


  if test "$withval" = "mysql"; then

     AC_CHECK_PROG(MYSQL_CONFIG, mysql_config, yes)

     if test x$MYSQL_CONFIG = xyes; then
       have_mysql="yes"
     fi

     if test "$have_mysql" = "yes"; then
            dnl AC_DEFINE(USE_MYSQL, 1, [MySQL database support enabled])

            mysql_includes=`mysql_config --cflags`
            mysql_libs=`mysql_config --libs_r`
            have_spamdrop="yes"
            parsembox="$parsembox"
            preparesql="prepare-sql aphash clapf_admin"
	    spamdrop="spamdrop"
	    spamdrop_install="install-spamdrop"

            test="test"
     else
        echo "MySQL support is not found"
        exit 1;
     fi
  fi



  if test "$withval" = "mydb"; then
     have_spamdrop="yes"
     parsembox="$parsembox"
     spamdrop="spamdrop mydb_stat mydb_compress"
     preparesql="prepare-sql aphash"
     spamdrop_install="install-spamdrop"
     test="test"
  fi


  parsembox="$parsembox "


])


AC_ARG_WITH(qcache,
[  --with-qcache[[=tcp|socket]]      use Qcache via either a TCP or Unix domain socket (default: none)],[
  if test "$withval" != "no" -a "$withval" != "yes"; then
    QCACHE=$withval
  else
    echo "please specify the connection type of the qcache: tcp or unix socket"; exit 1;
  fi
])



dnl lmtp support
    AC_ARG_ENABLE(lmtp,
          [  --enable-lmtp           use LMTP local delivery (default: SMTP)], want_lmtp=$enableval, want_lmtp="no")

dnl language detection
    AC_ARG_ENABLE(language-detection,
          [  --enable-language-detection use the language detection feature (experimental)], want_language_detection=$enableval, want_language_detection="no")


dnl external store
    AC_ARG_ENABLE(store,
          [  --enable-store          use external store to store emails for later retraining], want_store=$enableval, want_store="no")

    if test "$want_store" = "yes"; then
        defs="$defs -DHAVE_STORE"
        clapfstore="clapfstore"
        store_obj="store.o"
	clapfstore_install="install-clapfstore"
        have_store="yes"
    fi


dnl outgoing smtp support
    AC_ARG_ENABLE(outgoing-smtp,
          [  --enable-outgoing-smtp  enable outgoing SMTP server mode], want_outgoing_smtp=$enableval, want_outgoing_smtp="no")

    if test "$want_outgoing_smtp" = "yes"; then
       AC_DEFINE_UNQUOTED(OUTGOING_SMTP, 1, [enable outgoing smtp mode])
    fi


dnl enable spamsum support

    AC_ARG_ENABLE(spamsum,
          [  --enable-spamsum        enable spamsum support (experimental)], want_spamsum=$enableval, want_spamsum="no")

    if test "$want_spamsum" = "yes"; then
       spamsum="spamsum"
       defs="$defs -DHAVE_SPAMSUM"
       spamsum_libs="-lspamsum"
    fi


dnl user running clapf

AC_ARG_WITH(clapf-user,
    [  --with-clapf-user=username What user the clapf daemon shall be run as],
    [ CLAPF_USER=$withval ],
    [ CLAPF_USER=clapf ]
    )


dnl configure config directory

cfg_dir=`echo $sysconfdir | grep prefix`

if test -n "$cfg_dir"; then
    if test "$prefix" = "NONE"
    then
        cfg_dir="$ac_default_prefix/etc"
        my_prefix=$ac_default_prefix
    else
        cfg_dir="$prefix/etc"
        my_prefix=$prefix
    fi
else
    cfg_dir="$sysconfdir"
fi

CFGDIR=$cfg_dir
AC_SUBST(CFGDIR)
AC_DEFINE_UNQUOTED(CONFDIR,"$cfg_dir",[where to look for the config file])


dnl configure data directory

data_dir=`echo $localstatedir | grep prefix`

if test -n "$data_dir"; then
    if test "$prefix" = "NONE"
    then
        data_dir="$ac_default_prefix/var"
    else
        data_dir="$prefix/var"
    fi
else
    data_dir="$localstatedir"
fi

DATADIR=$data_dir
AC_SUBST(DATADIR)
AC_DEFINE_UNQUOTED(DATADIR,"$data_dir",[where to look for the data files])

dnl spamdrop helper program

    AC_ARG_ENABLE(spamdrop-helper,
          [  --enable-spamdrop-helper use external spamdrop helper program], want_spamdrop_helper=$enableval, want_spamdrop_helper="no")

    if test "$want_spamdrop_helper" = "yes"; then
        defs="$defs -DHAVE_SPAMDROP_HELPER"
    fi

    AC_DEFINE_UNQUOTED(SPAMDROP_HELPER_PROGRAM,"$my_prefix/libexec/clapf/spamdrop_helper",[where to look for the spamdrop helper file])




if test "x$TOKENDB" = "x" && test "$have_antispam" = "yes"; then echo "please specify the token database with --with-tokendb"; exit 1; fi

dnl tinycdb

if test "$TOKENDB" = "cdb"; then
   AC_CHECK_HEADERS(cdb.h)
   AC_HAVE_LIBRARY(cdb, AC_CHECK_LIB(cdb, cdb_find, have_cdb=yes, echo "you need the cdb package"; exit))
   defs="$defs -DHAVE_CDB"
   objs="$objs cdb.o"
   antispam_libs="$antispam_libs -lcdb"
fi

if test "$TOKENDB" = "sqlite3"; then
   defs="$defs -DHAVE_SQLITE3"
   sqlite3_libs="-lsqlite3 -lpthread"
   mysql_obj="sqlite3.o sql.o"
fi

if test "$TOKENDB" = "mysql"; then
   defs="$defs -DHAVE_MYSQL"
   mysql_obj="mysql.o sql.o"
fi

if test "$TOKENDB" = "mydb"; then
   defs="$defs -DHAVE_MYDB"
   mysql_obj="mydb.o"
fi

if test "x$QCACHE" != "x"; then
   if test "$have_antispam" = "no"; then
      echo "please specify the --with-tokendb option"
      exit 1
   fi
fi


if test "$have_antivirus" = "no" && test "$have_antispam" = "no"; then
   echo "you have not specified either antivirus or antispam support"
   exit 1
fi

dnl let us know if we are building on FreeBSD

if test "$os" = "FreeBSD"; then
   defs="$defs -DFREEBSD"
fi

if test "$os" = "Linux"; then
   defs="$defs -D_GNU_SOURCE"
fi

dnl whether we have antivirus support

if test "$have_libclamav" = "yes" || test "$have_clamd" = "yes" || test "$have_avg" = "yes" || test "$have_avast" = "yes" || test "$have_kav" = "yes"  || test "$have_drweb" = "yes" ; then
   defs="$defs -DHAVE_ANTIVIRUS"
fi

dnl if we need our mime code

if test "$have_avg" = "yes" ; then
   objs="$objs mime.o"
fi

echo; echo

if test "$have_libclamav" = "yes"; then
   echo "libclamav support: yes"
   libclamav="`clamav-config --libs` -lclamav"
   defs="$defs -DHAVE_LIBCLAMAV"
fi

if test "$have_clamd" = "yes"; then
   echo "clamd support: yes"
   objs="$objs clamd.o"
   defs="$defs -DHAVE_CLAMD"
fi

if test "$have_avg" = "yes"; then
   echo "AVG support: yes"
   objs="$objs avg.o"
   defs="$defs -DHAVE_AVG"
fi

if test "$have_avast" = "yes"; then
   echo "avast! support: yes"
   objs="$objs avast.o"
   defs="$defs -DHAVE_AVAST"
fi

if test "$have_kav" = "yes"; then
   echo "kav support: yes"
   objs="$objs kav.o"
   defs="$defs -DHAVE_KAV"
fi

if test "$have_drweb" = "yes"; then
   echo "Dr.Web support: yes"
   objs="$objs drweb.o"
   defs="$defs -DHAVE_DRWEB"
fi


if test "$have_antispam" = "yes"; then
   echo "antispam support: yes"
   defs="$defs -DHAVE_ANTISPAM"
   objs="$objs hash.o chi.o bayes.o score.o buffer.o"
fi


if test "$have_gsl" = "yes"; then
   echo "chi square implementation: GNU GSL"
else
   echo "chi square implementation: internal"
fi

if test "$have_blackhole" = "yes"; then
   echo "blackhole feature: yes"
   defs="$defs -DHAVE_BLACKHOLE"
   objs="$objs black.o"
else
   echo "blackhole feature: no"
fi

if test "$have_spamdrop" = "yes"; then
   echo "train utilities: yes"
else
   echo "train utilities: no"
fi

if test "$have_cgi" = "yes"; then
   echo "CGI interface: yes"
   if test "$TOKENDB" = "mysql" || test "$TOKENDB" = "sqlite3"; then
      cgi="spamcgi usercgi traincgi trainlogcgi statcgi"
   else
      cgi="spamcgi usercgi traincgi"
   fi
else
   echo "CGI interface: no"
fi


if test "$have_rbl" = "yes"; then
   echo "(SU)RBL support: yes"
   defs="$defs -DHAVE_SURBL"
   if test "$have_all_received" = "yes"; then
      defs="$defs -DHAVE_PROCESS_ALL_RECEIVED_LINES"
   fi
   objs="$objs rbl.o"
else
   echo "(SU)RBL support: no"
fi

if test "$keep_old_token_format" = "yes"; then
   defs="$defs -DHAVE_NO_64_HASH"
   echo "token format: old"
   db_install="install-mysql-old"
else
   echo "token format: hash (2^64)"
   db_install="install-mysql-new"
fi

if test "$USERDB" = "mysql" && test "$have_mysql" = "yes"; then
   echo "user database: mysql"
   defs="$defs -DHAVE_USERDB -DHAVE_USER_MYSQL"
   #objs="$objs user.o"
   user_obj="user.o"
fi

if test "$USERDB" = "ldap" && test "$have_ldap" = "yes"; then
   echo "user database: ldap"
   defs="$defs -DHAVE_USERDB -DHAVE_USER_LDAP"
   #objs="$objs user.o"
   user_obj="user.o"
   ldap_libs="-lldap -llber"
fi

echo "token database backend: $TOKENDB"

if test "$TOKENDB" = "sqlite3"; then
   db_install="install-sqlite3"
fi

if test "$QCACHE" = "tcp"; then
   defs="$defs -DHAVE_QCACHE -DHAVE_TCP"
   echo "Qcache: tcp"
   qcache="qcache"
   qcache_install="install-qcache"
fi
if test "$QCACHE" = "socket"; then
   defs="$defs -DHAVE_QCACHE"
   echo "Qcache: socket"
   qcache="qcache"
   qcache_install="install-qcache"
fi

if test "$have_store" = "yes"; then
   echo "store: clapfstore"
else
   echo "store: internal"
fi

if test "$want_spamsum" = "yes"; then
   echo "spamsum: yes"
else
   echo "spamsum: no"
fi

if test "$have_whitelist" = "yes"; then
   echo "whitelist: yes"
   defs="$defs -DHAVE_WHITELIST"
else
   echo "whitelist: no"
fi

if test "$have_case" = "yes"; then
   defs="$defs -DHAVE_CASE"
   echo "tokens are case sensitive: yes"
else
   echo "tokens are case sensitive: no"
fi

if test "$want_lmtp" = "yes" && test "$want_outgoing_smtp" = "no"; then
   echo "local delivery: LMTP"
   defs="$defs -DHAVE_LMTP"
else
   echo "local delivery: SMTP"
fi

if test "$want_language_detection" = "yes"; then
   echo "language detection: enabled"
   defs="$defs -DHAVE_LANG_DETECT"
   objs="$objs lang.o"
else
   echo "language detection: no"
fi

echo "clapf user: $CLAPF_USER"

if test "$have_static_build" = "yes"; then
   echo "link mode: static"
   static="-static"
else
   echo "link mode: dynamic"
fi


id -u $CLAPF_USER 2>/dev/null 1>/dev/null
if test $? -eq 1; then echo "the user \"$CLAPF_USER\" does not exists, please create it, first with adduser..."; exit 1; fi

if test "$have_libclamav" = "no" && test "$have_clamd" = "no" && test "$have_avg" = "no" && test "$have_avast" = "no" && test "$have_kav" = "no" && test "$have_drweb" = "no" ; then
   echo; echo
   echo "You have not selected any antivirus support."
   echo "clapf will not protect you from hostile code coming in e-mail"
fi

echo; echo



CFLAGS="$static -O2 -Wall -g"
LIBS="$libclamav $antispam_libs $gsl_libs $sqlite3_libs"
OBJS="misc.o cfg.o smtp.o sig.o decoder.o list.o parser.o cgi.o $objs"

AC_OUTPUT(Makefile)
AC_OUTPUT(contrib/spamsum/Makefile)
AC_OUTPUT(contrib/ooop/Makefile)
